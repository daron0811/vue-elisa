(function(){"use strict";function q(t){return t.length?t.reduce((e,r)=>e+r,0)/t.length:0}function A(t,e){const r=q(t),o=t.reduce((n,l)=>n+(l-r)**2,0),s=t.reduce((n,l,f)=>n+(l-e[f])**2,0);return o===0?1:1-s/o}function C(t,e){return e.m*t+e.b}function y(t,e){return t<=0&&(t=1e-12),e.d+(e.a-e.d)/(1+Math.pow(t/e.c,e.b))}function T(t,e){return t<=0&&(t=1e-12),e.d+(e.a-e.d)/Math.pow(1+Math.pow(t/e.c,e.b),e.e)}function j(t,e=1e-12){return t>e?t:e}function D(t,e){const r=t.length,o=t.reduce((h,m)=>h+m,0),s=e.reduce((h,m)=>h+m,0),n=t.reduce((h,m)=>h+m*m,0),l=t.reduce((h,m,L)=>h+m*e[L],0),f=r*n-o*o||1e-12,c=(r*l-o*s)/f,i=(s-c*o)/r,u=t.map(h=>C(h,{m:c,b:i}));return{params:{m:c,b:i},yhat:u}}function R(t,e,r=!1){const o=Math.max(...e),s=Math.min(...e),n=[...t].sort((M,w)=>M-w),l=n[Math.floor(n.length/2)]||1;let f=o,c=s,i=j(l),u=1,h=1,m=.01;const L=300;for(let M=0;M<L;M++){const w=t.map(a=>r?T(a,{a:f,b:u,c:i,d:c,e:h}):y(a,{a:f,b:u,c:i,d:c})),_=e.map((a,d)=>a-w[d]),E=_.reduce((a,d)=>a+d*d,0),J=r?["a","b","c","d","e"]:["a","b","c","d"],b={a:f,b:u,c:i,d:c,e:h},S=t.map(()=>new Array(J.length).fill(0)),v=1e-6;J.forEach((a,d)=>{const X=b[a];b[a]=X+v;const W=t.map(g=>r?T(g,b):y(g,b));b[a]=X;for(let g=0;g<t.length;g++)S[g][d]=(W[g]-w[g])/v});const z=F(S),P=G(z,S);for(let a=0;a<P.length;a++)P[a][a]+=m;const Q=H(z,_),I=K(P,Q);if(!I){m*=10;continue}const p={a:f,b:u,c:i,d:c,e:h};J.forEach((a,d)=>{p[a]=N(a,p[a]+I[d])});const U=t.map(a=>r?T(a,p):y(a,p)),V=e.map((a,d)=>a-U[d]).reduce((a,d)=>a+d*d,0);if(V<E?({a:f,b:u,c:i,d:c,e:h}=p,m=Math.max(m/2,1e-7)):m*=10,Math.abs(E-V)/Math.max(1,E)<1e-8)break}const O=t.map(M=>r?T(M,{a:f,b:u,c:i,d:c,e:h}):y(M,{a:f,b:u,c:i,d:c}));return{params:r?{a:f,b:u,c:i,d:c,e:h}:{a:f,b:u,c:i,d:c},yhat:O}}function F(t){return t[0].map((e,r)=>t.map(o=>o[r]))}function G(t,e){const r=t.length,o=e[0].length,s=e.length,n=Array.from({length:r},()=>Array(o).fill(0));for(let l=0;l<r;l++)for(let f=0;f<o;f++){let c=0;for(let i=0;i<s;i++)c+=t[l][i]*e[i][f];n[l][f]=c}return n}function H(t,e){return t.map(r=>r.reduce((o,s,n)=>o+s*e[n],0))}function K(t,e){const r=t.length,o=t.map(n=>n.slice()),s=e.slice();for(let n=0;n<r;n++){let l=n;for(let c=n+1;c<r;c++)Math.abs(o[c][n])>Math.abs(o[l][n])&&(l=c);if(Math.abs(o[l][n])<1e-12)return null;l!==n&&([o[n],o[l]]=[o[l],o[n]],[s[n],s[l]]=[s[l],s[n]]);const f=o[n][n];for(let c=n;c<r;c++)o[n][c]/=f;s[n]/=f;for(let c=0;c<r;c++)if(c!==n){const i=o[c][n];if(i===0)continue;for(let u=n;u<r;u++)o[c][u]-=i*o[n][u];s[c]-=i*s[n]}}return s}function N(t,e){return t==="c"?j(e):t==="e"?Math.max(.1,e):e}self.onmessage=t=>{try{const{model:e,xs:r,ys:o}=t.data;if(r.length!==o.length||r.length<2)throw new Error("資料點不足");let s,n;e==="Linear"?{params:s,yhat:n}=D(r,o):e==="4PL"?{params:s,yhat:n}=R(r,o,!1):{params:s,yhat:n}=R(r,o,!0);const l=A(o,n),f={ok:!0,params:s,yhat:n,r2:l};self.postMessage(f)}catch(e){const r={ok:!1,error:e?.message||"擬合失敗"};self.postMessage(r)}}})();
